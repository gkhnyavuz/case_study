with
CONTRACT_DETAIL  as 
(
    select * from 
    (
        values
      (1,DATE('2021-12-29'),'Mercedes','A200',20000),
      (2,DATE('2021-08-28'),'Mercedes','C200',30000),
      (3,DATE('2020-07-27'),'Mercedes','E250',40000),
      (4,DATE('2019-06-26'),'Mercedes','C200',25000),
      (5,DATE('2019-05-25'),'Mercedes','E250',45000),
      (6,DATE('2018-04-25'),'Mercedes','A200',15000),
      (7,DATE('2018-03-25'),'BMW','320',30000),
      (8,DATE('2018-02-25'),'PORCHE','911',80000),
      (9,DATE('2018-01-25'),'Mercedes','A200',18000),
      (10,DATE('2021-07-28'),'Mercedes','C200',28000),
      (11,DATE('2019-10-25'),'Mercedes','E250',42000)

        ) as a (IDCONTRACT,CONTRACTSTARTDATE,VEHICLEBRAND,MODELNAME,NETLISTPRICE)
),

A as 
(
 SELECT YEAR(CONTRACTSTARTDATE) YEAR,VEHICLEBRAND,MODELNAME,
 CAST(AVG(NETLISTPRICE) AS NUMERIC(20,2)) AVG_PRICE
 FROM CONTRACT_DETAIL  WHERE VEHICLEBRAND='Mercedes'
 GROUP BY 1,2,3
),

B as
(
  SELECT VEHICLEBRAND,MODELNAME,YEAR,AVG_PRICE,
  LAG(YEAR,1) OVER(PARTITION BY VEHICLEBRAND,MODELNAME ORDER BY YEAR ) PREV_YEAR,
  CAST(LAG(AVG_PRICE,1) OVER(PARTITION BY VEHICLEBRAND,MODELNAME ORDER BY YEAR ) AS NUMERIC(20,2)) PREV_YEAR_AVG_PRICE
  FROM A 
)

  SELECT *,
  CAST(((AVG_PRICE-PREV_YEAR_AVG_PRICE)/PREV_YEAR_AVG_PRICE)*100 AS NUMERIC(5,2)) AS DIFF_PERCENTAGE
  FROM B
